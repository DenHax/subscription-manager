# Subscription aggregation service

## Getting started

Для начала работы необходимо иметь хотя бы `Docker`. В данном проекте использовался `Docker 28.5.1`

```sh
cp ./.env.dist ./.env
docker compose up
```

Образ для docker compose можно собрать локально, для этого нужен git репозиторий с тегом и docker. Сборку можно начать, вызвав команду `make docker`, если в системе установлен `make` и `bash`, либо через `bash ./scripts/build-docker_subscriptions.sh.sh`, если установлен только `bash`

Также есть команда для сборки обычного исполняемого файла — `make native`

## Документация

При запуске сервиса по маршруту `http://localhost:8080/swagger/index.html` будет доступна документация swagger, реализованная с помощью `swaggo`, с помощью которой можно более наглядно тестировать API

## Текущая реализация бизнес-логики и функционала

## Архитектура проекта и кода

Архитектура кода — слоистая. `handler` отвечает за обработку запросов по HTTP, `service` отвечает за бизнес-логику, `repository` отвечает за хранение и доступ к данным
Каждый уровень отвечает за свою зону ответственности, при необходимости происходит обращение к другому ответственному инстансу на том же уровне

Архитектура проекта вдохновлена [схемой golang-standards](https://github.com/golang-standards/project-layout)

### Сущности

**Пользователь (`User`)** —

### Иерархия директорий и файлов в проекте

`/` — корень проекта, в данном случае сервиса агрегации данных об онлайн-подписках пользователей

`/api/` — директория для описания API сервиса, содержащая `openapi.yaml`, прилагающийся к заданию, предоставляет интерфейс взаимодействия внешних сущностей с сервисом

`/build/` — директория для образов и артефактов сборки

`/cmd/` — команды разрабатываемого сервиса, в данном случае одна команда — запуск сервиса `subscriptions`

`/configs/` — открытая конфигурация проекта, которая должна содержать специфичные для окружения файлы, такие как `dev.docker.yaml`, `prod.yaml`

`/deploy/` — директория, которая содержит конфигурации, необходимые для развертывания, в данном случае включает в себя `compose` — конфигурацию для `docker compose`

`/docs/` — директория для документации, в данном проекте — документации `swagger`

`/internal/` — директория пакетов, которые не должны использоваться внешними сущностями. Здесь сокрыта реализация бизнеслогики, работы с даннми, обработки запросов. Для доступа извне существует `/api` и `/pkg`

- `domain/` — место описания структу сущностей, DTO

- `http/` — транспортный уровень, в рамках проекта — `http`, содержит конфигурацию сервера в `server` и обработчики для каждого эндпоинта в `handlers`

- `middleware/` — содержит middlewares для транспортного уровня, в данном проекте здесь реализованы CORS

- `repo/` — уровень работы с данными, содержит функции для работы с реляционной базой данных для каждой сущности

- `service/` — уровень бизнес-логики, содержит функции для реализации функциональных требований к сервису

- `storage/` — содержит конфигурацию хранилища, в рамках данного проекта — `postgres`, предоставляя базу как `storage`, скрывая детали используемой базы данных

`/migrations/` — директория для хранения схемы миграций, в частности для `go-migrate`. Формат миграций (по два файла): `xxx-<name>.up|down.sql`

`/scripts/` — директория для скриптов, упрощающих процесс разработки, тестирования, сборки

- `build-docker_reivew.sh` — получает текущий тэг репозитория `git`, считает его как тэг репозитория OCI (например, dockerhub), собирает образ с помощью `buildx` с указанными параметрами, такими как имя репозитория, полученной версии.

- `build-native_reivew.sh` — получает текущий тэг репозитория `git`, использует его в ходе компиляции, компилиурет артефакт с указанием текущей версии и создает ссылку с тэгом `latest`

`/test/` — директория для e2e, интеграционных тестов

`/.env.dist` — пример файла переменных окружения с примером, содержащий необходимый их набор

`/.env` — файл переменных окружения для работы сервиса, содержащий чувствительную информацию

`/Makefile` — файл с командами проекта. При вводе `make` без аргументов отобразит доступные команды.

`/.golangci.yaml` — файл конфигурации линтера `golangci-ling` с большей частью значений по умолчанию

## Технологический стэк

- Golang 1.25.3 — компилируемый заточенный на разработку высоконагруженных сервисов язык программирования
- Gin v1.11.0 — web-framework с Express.js-style маршрутизацией, нацеленный на производительность,
- Postgres 17.7 — реляционная база данных с поддержкой транзакций и триггеров
- Docker 28.5.1, Docker compose 2.39.4 — популярный инструмент сборки, упаковки и развертывания приложений со встроенным средством оркестрирования `Docker compose`
- Nix 2.31.2 (flake) — пакетный менеджер и средство конфигурации среды разработки с `devShells`, с возможностью контроля версий утилит разработки через `flake.lock`
- Go-migrate 4.19.0 (latest) — утилита для осуществления миграций
- Golangci-ling 2.6.1 — металинтер для проверки кода на соответствие описанным в файле конфигурации стандартам
